apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ml-job-template  # <--- ì´ ì´ë¦„ì„ Sensorì—ì„œ ì°¸ì¡°í•©ë‹ˆë‹¤
  namespace: argo
spec:
  # ì™¸ë¶€(Sensor)ì—ì„œ ë°›ì•„ì˜¬ íŒŒë¼ë¯¸í„° ì •ì˜
  arguments:
    parameters:
    - name: git-ref
    - name: git-sha

  entrypoint: ml-pipeline

  volumes:
  - name: work-pvc
    hostPath:
      # ë‚´ ë§¥ë¶ì˜ ì‹¤ì œ ê²½ë¡œ (Docker Desktopì€ /Users ê²½ë¡œë¥¼ ê¸°ë³¸ ê³µìœ í•¨)
      path: /Users/sumin7kim/Desktop/argo-workflows-local-demo/artifacts
      type: Directory

  templates:
  # 1. íŒŒì´í”„ë¼ì¸ ì •ì˜
  - name: ml-pipeline
    steps:
    - - name: checkout
        template: git-checkout
    - - name: init-env
        template: init-uv-env
    - - name: run-task
        template: run-repo-file

  # 2. [Git Checkout] ì½”ë“œë¥¼ ë³¼ë¥¨ìœ¼ë¡œ ë‚´ë ¤ë°›ìŒ
  - name: git-checkout
    container:
      image: alpine/git
      workingDir: /mnt/workspace
      env:
        - name: GIT_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-access
              key: token
      command: ["/bin/sh", "-c"]
      args:
      - |
        echo "â¬‡ï¸ Cloning repository: sumin7kim/argo-workflows-local-demo..."
        
        # Git SSL ê²€ì¦ ë¹„í™œì„±í™”
        git config --global http.sslVerify false

        # ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì •ë¦¬
        rm -rf source
        
        # Private Repo ì ‘ê·¼ì„ ìœ„í•´ Token ì‚¬ìš© (github-access ì‹œí¬ë¦¿ í™œìš©)
        git clone https://$(GIT_TOKEN)@github.com/sumin7kim/argo-workflows-local-demo.git source
        
        cd source
        # Webhookì—ì„œ ì „ë‹¬ë°›ì€ ë¸Œëœì¹˜/ì»¤ë°‹ìœ¼ë¡œ ì´ë™
        # (Workflow parameter ì‚¬ìš©)
        git checkout {{workflow.parameters.git-sha}}
        
        echo "âœ… Checkout complete at $(git rev-parse --short HEAD)"
      volumeMounts:
      - name: work-pvc
        mountPath: /mnt/workspace

  # 3. [Init Env] UVë¡œ ì˜ì¡´ì„± ì„¤ì¹˜
  - name: init-uv-env
    container:
      image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
      workingDir: /mnt/workspace/source
      command: ["/bin/sh", "-c"]
      args:
      - |
        echo "ğŸš€ [Init] Setting up environment..."
        
        # 1. ê°€ìƒí™˜ê²½ ìƒì„±
        uv venv /mnt/workspace/.venv --allow-existing
        
        # SSL ì—ëŸ¬ ë¬´ì‹œ ì˜µì…˜
        UV_FLAGS="--allow-insecure-host pypi.org --allow-insecure-host files.pythonhosted.org"

        echo "ğŸ“¦ Installing dependencies..."

        # â–¼â–¼â–¼ [ìˆ˜ì • í¬ì¸íŠ¸] â–¼â–¼â–¼
        # 1. '/mnt/workspace/.venv/bin/uv' -> ê·¸ëƒ¥ 'uv' ì‚¬ìš©
        # 2. '--python /mnt/workspace/.venv' ì˜µì…˜ìœ¼ë¡œ ì„¤ì¹˜ ìœ„ì¹˜ ì§€ì •
        
        if [ -f "requirements.txt" ]; then
          uv pip install -r requirements.txt --python /mnt/workspace/.venv $UV_FLAGS
        else
          echo "âš ï¸ No requirements.txt found. Installing defaults..."
          uv pip install pandas numpy scikit-learn joblib --python /mnt/workspace/.venv $UV_FLAGS
        fi
        
        echo "âœ… Environment setup complete."      
      volumeMounts:
      - name: work-pvc
        mountPath: /mnt/workspace

  # 4. [Run File] ë ˆí¬ì§€í† ë¦¬ ë‚´ íŠ¹ì • íŒŒì¼ ì‹¤í–‰
  - name: run-repo-file
    container:
      image: python:3.11-slim-bookworm
      workingDir: /mnt/workspace/source
      command: ["/bin/sh", "-c"]
      args:
      - |
        echo "ğŸ”¥ [Run] Executing target script..."
        
        # [ìˆ˜ì •] source ëŒ€ì‹  ê°€ìƒí™˜ê²½ ë‚´ì˜ pythonì„ ì§ì ‘ í˜¸ì¶œ
        PYTHON_EXEC="/mnt/workspace/.venv/bin/python"
        
        if [ -f "main.py" ]; then
          $PYTHON_EXEC main.py
        else
          echo "Error: main.py not found in repo!"
          ls -al
          exit 1
        fi
      volumeMounts:
      - name: work-pvc
        mountPath: /mnt/workspace