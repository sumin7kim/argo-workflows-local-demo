apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ml-job-template
  namespace: argo
spec:
  arguments:
    parameters:
    - name: git-ref
    - name: git-sha

  entrypoint: ml-pipeline

  volumes:
  - name: workspace-vol
    hostPath:
      path: /Users/sumin7kim/Desktop/argo-artifacts
      type: Directory

  templates:
  # [Main Pipeline] ì‹¤í–‰ ìˆœì„œ ì •ì˜ (DAG)
  - name: ml-pipeline
    dag:
      tasks:
      - name: checkout
        template: git-checkout
        
      - name: init-env
        template: init-uv-env
        dependencies: [checkout]
        
      - name: ingest
        template: run-script
        dependencies: [init-env]
        arguments:
          parameters: [{name: script-name, value: "src/ingest.py"}]
          
      - name: preprocess
        template: run-script
        dependencies: [ingest]
        arguments:
          parameters: [{name: script-name, value: "src/preprocess.py"}]
          
      - name: train
        template: run-script
        dependencies: [preprocess]
        arguments:
          parameters: [{name: script-name, value: "src/train.py"}]

  # [Step 1] Git Checkout
  - name: git-checkout
    container:
      image: alpine/git
      workingDir: /mnt/workspace
      env:
        - name: GIT_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-access
              key: token
      command: ["/bin/sh", "-c"]
      args:
      - |
        echo "â¬‡ï¸ Cloning repository..."
        git config --global http.sslVerify false
        rm -rf source
        git clone https://$(GIT_TOKEN)@github.com/sumin7kim/argo-workflows-local-demo.git source
        cd source
        git checkout {{workflow.parameters.git-sha}}
        echo "âœ… Checkout complete"
    volumeMounts:
    - name: workspace-vol
      mountPath: /mnt/workspace

  # [Step 2] UV Init (í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ì—¬ í™˜ê²½ êµ¬ì„±)
  - name: init-uv-env
    container:
      image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
      workingDir: /mnt/workspace/source
      command: ["/bin/sh", "-c"]
      args:
      - |
        echo "ğŸš€ [Init] Setting up UV environment..."
        uv venv /mnt/workspace/.venv --allow-existing
        
        UV_FLAGS="--allow-insecure-host pypi.org --allow-insecure-host files.pythonhosted.org"
        
        # ì˜ì¡´ì„± ì„¤ì¹˜
        uv pip install -r requirements.txt --python /mnt/workspace/.venv $UV_FLAGS
    volumeMounts:
    - name: workspace-vol
      mountPath: /mnt/workspace

  # [Step 3,4,5] Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ê¸° (ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í…œí”Œë¦¿)
  - name: run-script
    inputs:
      parameters:
      - name: script-name
    container:
      image: python:3.11-slim-bookworm
      workingDir: /mnt/workspace/source
      command: ["/bin/sh", "-c"]
      args:
      - |
        echo "Running {{inputs.parameters.script-name}}..."
        # ê°€ìƒí™˜ê²½ì˜ Pythonìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        /mnt/workspace/.venv/bin/python {{inputs.parameters.script-name}}
    volumeMounts:
    - name: workspace-vol
      mountPath: /mnt/workspace