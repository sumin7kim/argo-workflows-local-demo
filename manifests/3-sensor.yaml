# sensor.yaml
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: github-sensor
  namespace: argo
spec:
  dependencies:
    - name: demo
      eventSourceName: github-events
      eventName: example
  triggers:
    - template:
        name: github-ml-pipeline-trigger
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: ml-git-pipeline-
                namespace: argo
              spec:
                # [ì¤‘ìš”] Webhookì—ì„œ ë°›ì€ íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„ ì–¸
                arguments:
                  parameters:
                  - name: git-ref
                    value: "main"  # ê¸°ë³¸ê°’
                  - name: git-sha
                    value: "HEAD"
                    
                entrypoint: ml-pipeline
                
                # ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ë³¼ë¥¨ (ì†ŒìŠ¤ì½”ë“œ + ê°€ìƒí™˜ê²½ ê³µìœ )
                volumeClaimTemplates:
                - metadata:
                    name: work-pvc
                  spec:
                    accessModes: [ "ReadWriteOnce" ]
                    resources:
                      requests:
                        storage: 2Gi

                templates:
                # 1. íŒŒì´í”„ë¼ì¸ ì •ì˜
                - name: ml-pipeline
                  steps:
                  - - name: checkout
                      template: git-checkout
                  - - name: init-env
                      template: init-uv-env
                  - - name: run-task
                      template: run-repo-file

                # 2. [Git Checkout] ì½”ë“œë¥¼ ë³¼ë¥¨ìœ¼ë¡œ ë‚´ë ¤ë°›ìŒ
                - name: git-checkout
                  container:
                    image: alpine/git
                    workingDir: /mnt/workspace
                    env:
                      - name: GIT_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: github-access
                            key: token
                    command: ["/bin/sh", "-c"]
                    args:
                    - |
                      echo "â¬‡ï¸ Cloning repository: sumin7kim/argo-workflows-local-demo..."
                      # ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì •ë¦¬
                      rm -rf source
                      
                      # Private Repo ì ‘ê·¼ì„ ìœ„í•´ Token ì‚¬ìš© (github-access ì‹œí¬ë¦¿ í™œìš©)
                      git clone https://$(GIT_TOKEN)@github.com/sumin7kim/argo-workflows-local-demo.git source
                      
                      cd source
                      # Webhookì—ì„œ ì „ë‹¬ë°›ì€ ë¸Œëžœì¹˜/ì»¤ë°‹ìœ¼ë¡œ ì´ë™
                      # (Workflow parameter ì‚¬ìš©)
                      git checkout {{workflow.parameters.git-sha}}
                      
                      echo "âœ… Checkout complete at $(git rev-parse --short HEAD)"
                    volumeMounts:
                    - name: work-pvc
                      mountPath: /mnt/workspace

                # 3. [Init Env] UVë¡œ ì˜ì¡´ì„± ì„¤ì¹˜
                - name: init-uv-env
                  container:
                    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
                    workingDir: /mnt/workspace/source
                    command: ["/bin/sh", "-c"]
                    args:
                    - |
                      echo "ðŸš€ [Init] Setting up environment..."
                      
                      # 1. ê°€ìƒí™˜ê²½ ìƒì„± (ì´ë¯¸ ìžˆìœ¼ë©´ ë®ì–´ì“°ê¸° ìœ„í•´ --allow-existing ì¶”ê°€)
                      uv venv /mnt/workspace/.venv --allow-existing
                      
                      # 2. íŒ¨í‚¤ì§€ ì„¤ì¹˜
                      # [ìˆ˜ì • 1] 'source' ëŒ€ì‹  ì „ì²´ ê²½ë¡œ ì‚¬ìš© (ì‰˜ í˜¸í™˜ì„± í•´ê²°)
                      # [ìˆ˜ì • 2] SSL ì—ëŸ¬ ë¬´ì‹œ ì˜µì…˜ ì¶”ê°€ (--allow-insecure-host)
                      
                      echo "ðŸ“¦ Installing dependencies..."
                      
                      UV_FLAGS="--allow-insecure-host pypi.org --allow-insecure-host files.pythonhosted.org"

                      if [ -f "requirements.txt" ]; then
                        /mnt/workspace/.venv/bin/uv pip install -r requirements.txt $UV_FLAGS
                      else
                        echo "âš ï¸ No requirements.txt found. Installing defaults..."
                        /mnt/workspace/.venv/bin/uv pip install pandas numpy scikit-learn joblib $UV_FLAGS
                      fi
                      
                      echo "âœ… Environment setup complete."
                    volumeMounts:
                    - name: work-pvc
                      mountPath: /mnt/workspace

                # 4. [Run File] ë ˆí¬ì§€í† ë¦¬ ë‚´ íŠ¹ì • íŒŒì¼ ì‹¤í–‰
                - name: run-repo-file
                  container:
                    image: python:3.11-slim-bookworm
                    workingDir: /mnt/workspace/source
                    command: ["/bin/sh", "-c"]
                    args:
                    - |
                      echo "ðŸ”¥ [Run] Executing target script..."
                      
                      # [ìˆ˜ì •] source ëŒ€ì‹  ê°€ìƒí™˜ê²½ ë‚´ì˜ pythonì„ ì§ì ‘ í˜¸ì¶œ
                      PYTHON_EXEC="/mnt/workspace/.venv/bin/python"
                      
                      if [ -f "main.py" ]; then
                        $PYTHON_EXEC main.py
                      else
                        echo "Error: main.py not found in repo!"
                        ls -al
                        exit 1
                      fi
                    volumeMounts:
                    - name: work-pvc
                      mountPath: /mnt/workspace

          # [íŠ¸ë¦¬ê±° íŒŒë¼ë¯¸í„° ë§¤í•‘] Webhook JSON -> Workflow Parameter
          parameters:
            - src:
                dependencyName: demo
                dataKey: body.ref
              dest: spec.arguments.parameters.0.value # git-ref
            - src:
                dependencyName: demo
                dataKey: body.after
              dest: spec.arguments.parameters.1.value # git-sha