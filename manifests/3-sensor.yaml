# sensor.yaml
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: github-sensor
  namespace: argo
spec:
  dependencies:
    - name: demo
      eventSourceName: github-events
      eventName: example
  triggers:
    - template:
        name: github-ml-pipeline-trigger
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: ml-git-pipeline-
                namespace: argo
              spec:
                # [ì¤‘ìš”] Webhookì—ì„œ ë°›ì€ íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„ ì–¸
                arguments:
                  parameters:
                  - name: git-ref
                    value: "main"  # ê¸°ë³¸ê°’
                  - name: git-sha
                    value: "HEAD"
                    
                entrypoint: ml-pipeline
                
                # ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ë³¼ë¥¨ (ì†ŒìŠ¤ì½”ë“œ + ê°€ìƒí™˜ê²½ ê³µìœ )
                volumeClaimTemplates:
                - metadata:
                    name: work-pvc
                  spec:
                    accessModes: [ "ReadWriteOnce" ]
                    resources:
                      requests:
                        storage: 2Gi

                templates:
                # 1. íŒŒì´í”„ë¼ì¸ ì •ì˜
                - name: ml-pipeline
                  steps:
                  - - name: checkout
                      template: git-checkout
                  - - name: init-env
                      template: init-uv-env
                  - - name: run-task
                      template: run-repo-file

                # 2. [Git Checkout] ì½”ë“œë¥¼ ë³¼ë¥¨ìœ¼ë¡œ ë‚´ë ¤ë°›ìŒ
                - name: git-checkout
                  container:
                    image: alpine/git
                    workingDir: /mnt/workspace
                    env:
                      - name: GIT_TOKEN
                        valueFrom:
                          secretKeyRef:
                            name: github-access
                            key: token
                    command: ["/bin/sh", "-c"]
                    args:
                    - |
                      echo "â¬‡ï¸ Cloning repository: sumin7kim/argo-workflows-local-demo..."
                      # ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì •ë¦¬
                      rm -rf source
                      
                      # Private Repo ì ‘ê·¼ì„ ìœ„í•´ Token ì‚¬ìš© (github-access ì‹œí¬ë¦¿ í™œìš©)
                      git clone https://$(GIT_TOKEN)@github.com/sumin7kim/argo-workflows-local-demo.git source
                      
                      cd source
                      # Webhookì—ì„œ ì „ë‹¬ë°›ì€ ë¸Œëžœì¹˜/ì»¤ë°‹ìœ¼ë¡œ ì´ë™
                      # (Workflow parameter ì‚¬ìš©)
                      git checkout {{workflow.parameters.git-sha}}
                      
                      echo "âœ… Checkout complete at $(git rev-parse --short HEAD)"
                    volumeMounts:
                    - name: work-pvc
                      mountPath: /mnt/workspace

                # 3. [Init Env] UVë¡œ ì˜ì¡´ì„± ì„¤ì¹˜
                - name: init-uv-env
                  container:
                    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
                    workingDir: /mnt/workspace/source
                    command: ["/bin/sh", "-c"]
                    args:
                    - |
                      echo "ðŸš€ [Init] Setting up environment..."
                      
                      # ê°€ìƒí™˜ê²½ ìƒì„± (ì†ŒìŠ¤ í´ë” ì™¸ë¶€ì— ìƒì„±í•˜ì—¬ ê¹”ë”í•˜ê²Œ ìœ ì§€)
                      uv venv /mnt/workspace/.venv
                      
                      # í™œì„±í™”
                      source /mnt/workspace/.venv/bin/activate
                      
                      # ë ˆí¬ì§€í† ë¦¬ì— ìžˆëŠ” requirements.txt ì„¤ì¹˜
                      if [ -f "requirements.txt" ]; then
                        echo "ðŸ“¦ Installing dependencies from requirements.txt..."
                        uv pip install -r requirements.txt
                      else
                        echo "âš ï¸ No requirements.txt found. Installing defaults..."
                        uv pip install pandas numpy scikit-learn
                      fi
                    volumeMounts:
                    - name: work-pvc
                      mountPath: /mnt/workspace

                # 4. [Run File] ë ˆí¬ì§€í† ë¦¬ ë‚´ íŠ¹ì • íŒŒì¼ ì‹¤í–‰
                - name: run-repo-file
                  container:
                    image: python:3.11-slim-bookworm
                    workingDir: /mnt/workspace/source
                    command: ["/bin/sh", "-c"]
                    args:
                    - |
                      echo "ðŸ”¥ [Run] Executing target script..."
                      source /mnt/workspace/.venv/bin/activate
                      
                      # â–¼â–¼â–¼ [ìˆ˜ì • í¬ì¸íŠ¸] ì‹¤í–‰í•  íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•˜ì„¸ìš” â–¼â–¼â–¼
                      # ì˜ˆ: ë ˆí¬ì§€í† ë¦¬ ë£¨íŠ¸ì˜ main.py ì‹¤í–‰
                      if [ -f "main.py" ]; then
                        python main.py
                      else
                        echo "Error: main.py not found in repo!"
                        ls -al
                        exit 1
                      fi
                    volumeMounts:
                    - name: work-pvc
                      mountPath: /mnt/workspace

          # [íŠ¸ë¦¬ê±° íŒŒë¼ë¯¸í„° ë§¤í•‘] Webhook JSON -> Workflow Parameter
          parameters:
            - src:
                dependencyName: demo
                dataKey: body.ref
              dest: spec.arguments.parameters.0.value # git-ref
            - src:
                dependencyName: demo
                dataKey: body.after
              dest: spec.arguments.parameters.1.value # git-sha